test_editors:
  - version: 2019.3.0f1
  # Trunk disabled because HDRP 7.1.2 does not compile on trunk. see https://unity.slack.com/archives/C6Y79CZM0/p1571936554247900
  #- version: trunk
suites:
  - name: standalone
# Marked Flakey due to issue with Shader.WarmupAllShaders in test players.
    display_name: (flakey) standalone
    args: --suite=playmode --platform=
  - name: editmode
    display_name: editmode
    args: --suite=playmode --suite=editor --platform=Editor
---

{% for editor in test_editors %}
{% for suite in suites %}
simviztest_windows_{{suite.name}}_{{editor.version}}:
  name : SimVizTest {{ suite.display_name }} tests ({{ editor.version }}, Windows)
  agent:
    type: Unity::VM
    image: package-ci/win10:stable
    flavor: b1.large
  commands:
    - git clone git@github.cds.internal.unity3d.com:unity/utr.git utr
    - pip install unity-downloader-cli --extra-index-url https://artifactory.eu-cph-1.unityops.net/api/pypi/common-python/simple
    - unity-downloader-cli -u {{ editor.version }} -c editor -c StandaloneSupport-Mono -c Linux --wait --published
    {% if suite.name == "standalone" %}
    - utr/utr --testproject=./TestProjects/SimVizTest --editor-location=./.Editor --artifacts_path=test-results --stdout-filter=minimal --extra-editor-arg="--force-d3d11" {{suite.args}}StandaloneWindows64
    {% else %}
    - utr/utr --testproject=./TestProjects/SimVizTest --editor-location=./.Editor --artifacts_path=test-results --stdout-filter=minimal --extra-editor-arg="--force-d3d11" {{suite.args}}
    {% endif %}
  artifacts:
    logs:
      paths:
        - "test-results/**/*"
{% endfor %} 
{% endfor %}

{% for editor in test_editors %}
{% for suite in suites %}
simviztest_linux_{{suite.name}}_{{editor.version}}:
  name : (Flakey) SimVizTest {{ suite.display_name }} tests ({{ editor.version }}, Linux)
  agent:
    type: Unity::VM::GPU
    image: cds-ops/ubuntu-18.04-base:latest
    flavor: b1.large
  commands:
    - sudo -H pip install --upgrade pip
    - sudo -H pip install unity-downloader-cli --extra-index-url https://artifactory.eu-cph-1.unityops.net/api/pypi/common-python/simple
    - git clone git@github.cds.internal.unity3d.com:unity/utr.git utr
    - sudo unity-downloader-cli -u {{ editor.version }} -c editor -c StandaloneSupport-Mono -c Linux --wait --published
    {% if suite.name == "standalone" %}
    - DISPLAY=:0.0 utr/utr --testproject=./TestProjects/SimVizTest --editor-location=.Editor --artifacts_path=test-results --stdout-filter=minimal --extra-editor-arg="--force-vulkan" {{suite.args}}StandaloneLinux64
    {% else %}
    - DISPLAY=:0.0 utr/utr --testproject=./TestProjects/SimVizTest --editor-location=.Editor --artifacts_path=test-results --stdout-filter=minimal --extra-editor-arg="--force-vulkan" {{suite.args}}
    {% endif %}
  artifacts:
    logs:
      paths:
        - "test-results/**/*"
{% endfor %} 
{% endfor %}

# Not including OSX because the only OSX platform on Bokken with a GPU is a Mac Mini, of which there are only a few and setting up Yamato jobs is very complicated.